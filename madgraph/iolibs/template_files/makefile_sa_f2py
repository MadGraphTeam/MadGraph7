include ../Source/make_opts
SHELL = /bin/bash
ROOT_DIR:=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))/../
LIBDIR = $(ROOT_DIR)/lib/
PROG   = check
LINKLIBS_ME =  -L$(ROOT_DIR)/lib/ -ldhelas -lmodel
LINKLIBS_ALL =  -L$(ROOT_DIR)/lib/ -lmatrix -ldhelas -lmodel
LIBS = $(LIBDIR)libdhelas.$(libext) $(LIBDIR)libmodel.$(libext)
PROCESS=  allmatrix.o
LIBRARY = libmatrix.a
F_INCLUDE = -I$(ROOT_DIR)/Source/DHELAS -I$(ROOT_DIR)/Source/MODEL -I$(ROOT_DIR)/SubProcesses
FFLAGS+=$(F_INCLUDE)

ifeq ($(strip $(HERE)),)
    HERE := $(abspath ./)
endif


PROCNAME= $(notdir $(dir $(abspath $(HERE))))

# For python linking (require f2py part of numpy)
ifeq ($(origin MENUM),undefined)
  MENUM=2
endif

#%$(MENUM)py.so: %/matrix.f
#	$(F2PY) --f77exec=$(FC) $(LINKLIBS_ME) -c $^ -m $(patsubst %/matrix.f,%$(MENUM)py,$^) --include-paths=$(HERE)/$(patsubst %/matrix.f,%,$^)
	
	
#all_matrix$(MENUM)py.so: $(LIBDIR)/$(LIBRARY) all_matrix.f
#	$(F2PY) --f77exec=$(FC) $(LINKLIBS_ALL) -c all_matrix.f -m all_matrix$(MENUM)py --include-paths=$(HERE)

$(LIBDIR)libmodel.$(libext):
	cd ../Source/MODEL; make

%$(MENUM)py.so: %/matrix.f $(LIBS)
	cd $(shell dirname $(realpath $(firstword $^))); echo $(shell pwd);  MENUM=$(MENUM) make matrix$(MENUM)py.so
	ln -sf $(shell dirname $(realpath $(firstword $^)))/matrix$(MENUM)py*.so $(patsubst %/matrix.f,%$(MENUM)py,$(firstword $^)).so


$(LIBDIR)/libdhelas.$(dylibext):
	$(MAKE) -C "$(LIBDIR)/../Source/DHELAS" shared
$(LIBDIR)/libmodel.$(dylibext):
	$(MAKE) -C "$(LIBDIR)/../Source/MODEL" shared


MATRIX_SRCS := $(wildcard */matrix.f)
MATRIX_OBJS := $(patsubst %.f,%.o,$(wildcard */matrix.f))

%/matrix.o: %/matrix.f
	$(MAKE) -C $* matrix.o

liball$(PROCNAME)_$(MENUM)me.$(dylibext): $(LIBDIR)/libdhelas.$(dylibext) $(LIBDIR)/libmodel.$(dylibext) all_matrix.o $(MATRIX_OBJS)
	 $(FC) $(DYNLIBFLAG) $(RPATHFLAG)liball$(PROCNAME)_$(MENUM)me.$(dylibext) -o liball$(PROCNAME)_$(MENUM)me.$(dylibext) all_matrix.o */matrix.o ../Source/DHELAS/*.o ../Source/MODEL/*.o $(F_INCLUDE)

shared: liball$(PROCNAME)_$(MENUM)me.$(dylibext)

all_matrix$(MENUM)py.so:  liball$(PROCNAME)_$(MENUM)me.$(dylibext) f2py_wrapper.f makefile
	LDFLAGS="-Wl,-rpath,$(HERE)" $(F2PY)  -c f2py_wrapper.f -L$(HERE) -lall$(PROCNAME)_$(MENUM)me $(LINKLIBS) -m                 all_matrix$(MENUM)py
	touch all_matrix$(MENUM)py.so

f2py: all_matrix$(MENUM)py.so
