include ../Source/make_opts
SHELL = /bin/bash
ROOT_DIR:=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))/../
LIBDIR = $(ROOT_DIR)/lib/
PROG   = check
LINKLIBS_ME =  -L$(ROOT_DIR)/lib/ -ldhelas -lmodel
LINKLIBS_ALL =  -L$(ROOT_DIR)/lib/ -lmatrix -ldhelas -lmodel
LIBS = $(LIBDIR)libdhelas.$(libext) $(LIBDIR)libmodel.$(libext)
PROCESS=  allmatrix.o
LIBRARY = libmatrix.a
F_INCLUDE = -I$(ROOT_DIR)/Source/DHELAS -I$(ROOT_DIR)/Source/MODEL -I$(ROOT_DIR)/SubProcesses

# For python linking (require f2py part of numpy)
ifeq ($(origin MENUM),undefined)
  MENUM=2
endif

$(LIBDIR)libdhelas.$(libext):
	cd ../Source/DHELAS;make

$(LIBDIR)libmodel.$(libext):
	cd ../Source/MODEL; make

%$(MENUM)py.so: %/matrix.f $(LIBS)
	cd $(shell dirname $(realpath $(firstword $^))); echo $(shell pwd);  MENUM=$(MENUM) make matrix$(MENUM)py.so
	ln -sf $(shell dirname $(realpath $(firstword $^)))/matrix$(MENUM)py*.so $(patsubst %/matrix.f,%$(MENUM)py,$(firstword $^)).so

all_matrix$(MENUM)py.so: $(LIBDIR)/$(LIBRARY) all_matrix.f allmatrix$(MENUM)py.py
	$(F2PY) --f77exec=$(FC) $(F_INCLUDE) $(LINKLIBS_ALL) -c all_matrix.f -m all_matrix$(MENUM)py
    
allmatrix$(MENUM)py.py: $(patsubst %/matrix.f,%$(MENUM)py.so,$(wildcard */matrix.f))
	rm -f allmatrix$(MENUM)py.py
	for lib in $(patsubst %$(MENUM)py.so,%.matrix$(MENUM)py,$^); do \
	     printf "try:\n    from $$lib import *\nexcept:\n    from .$$lib import *\n" >> allmatrix$(MENUM)py.py; \
	done;\
	printf "try: from all_matrix2py import *\nexcept:\n    from .all_matrix2py import *\n" >> allmatrix$(MENUM)py.py

allmatrix$(MENUM)py.so: all_matrix$(MENUM)py.so allmatrix$(MENUM)py.py
	
all_matrix.o: all_matrix.f
	${FC} ${FFLAGS} ${F_INCLUDE}  -c -o all_matrix.o all_matrix.f

#$(LIBDIR)/$(LIBRARY): $(patsubst %.f,%.o,$(wildcard */matrix.f))  all_matrix.o
$(LIBDIR)/$(LIBRARY):  all_matrix.o
	$(call CREATELIB, $@, $^)  

