include ../../Source/make_opts

ROOT_DIR:=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))/../
SHELL = /bin/bash
LIBDIR = $(ROOT_DIR)/lib/
PROG   = check
PDIR:=$(shell dirname $(realpath --no-symlinks $(firstword matrix.f)))
PROG_SPLITORDERS = check_sa_born_splitOrders
LINKLIBS =  -L$(ROOT_DIR)/lib/ -ldhelas -lmodel
LIBS = $(LIBDIR)libdhelas.$(libext) $(LIBDIR)libmodel.$(libext)
PROCESS=  matrix.o
CHECK_SA=  check_sa.o
CHECK_SA_SPLITORDERS=  check_sa_born_splitOrders.o
 
$(PROG): $(LIBS) $(PROCESS) $(CHECK_SA) makefile
	$(FC) $(FFLAGS) -o $(PROG) $(PROCESS) $(CHECK_SA) $(LINKLIBS)

$(PROG_SPLITORDERS): $(PROCESS) $(CHECK_SA_SPLITORDERS) makefile $(LIBS)
	$(FC) $(FFLAGS) -o $(PROG) $(PROCESS) $(CHECK_SA_SPLITORDERS) $(LINKLIBS)

driver.f: nexternal.inc pmass.inc ngraphs.inc coupl.inc
F_INCLUDE = -I$(ROOT_DIR)/Source/DHELAS -I$(ROOT_DIR)/Source/MODEL -I$(PDIR)
FFLAGS += $(F_INCLUDE)

$(LIBDIR)libdhelas.$(libext):
	cd ../../Source/DHELAS;make

$(LIBDIR)libmodel.$(libext):
	cd ../../Source/MODEL; make

# For python linking (require f2py part of numpy)
ifeq ($(origin MENUM),undefined)
  MENUM=2
endif


matrix$(MENUM)py.so: matrix.f makefile $(LIBS) 
	touch __init__.py
	$(F2PY) $(LINKLIBS) $(F_INCLUDE) -c  matrix.f -m matrix$(MENUM)py --f77exec=$(FC) 
